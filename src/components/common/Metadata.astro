---
import merge from 'lodash.merge';
import { SEO } from 'astro-seo';

import type { SEOProps } from 'astro-seo';

import { SITE, METADATA, I18N } from 'astrowind:config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';

import { adaptOpenGraphImages } from '~/utils/images';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
} = Astro.props;

// Adapt the openGraph format from the old @astrolib/seo format to the new astro-seo format
const adaptedOpenGraph = await adaptOpenGraphImages(
  merge(
    {},
    METADATA?.openGraph || {},
    openGraph
  ),
  Astro.site
);

// Build openGraph in the format required by astro-seo
const openGraphFormatted: SEOProps['openGraph'] = adaptedOpenGraph?.images?.[0]
  ? {
      basic: {
        title: title || METADATA?.title?.default || '',
        type: adaptedOpenGraph.type || 'website',
        image: adaptedOpenGraph.images[0].url,
        url: canonical,
      },
      optional: {
        siteName: adaptedOpenGraph.site_name || SITE?.name,
        locale: adaptedOpenGraph.locale || I18N?.language || 'en',
        description: description || METADATA?.description,
      },
      image: adaptedOpenGraph.images[0].width
        ? {
            width: adaptedOpenGraph.images[0].width,
            height: adaptedOpenGraph.images[0].height,
          }
        : undefined,
    }
  : undefined;

const seoProps: SEOProps = {
  title: title || METADATA?.title?.default,
  titleTemplate: ignoreTitleTemplate ? '%s' : METADATA?.title?.template,
  titleDefault: METADATA?.title?.default,
  canonical: canonical,
  noindex: typeof robots?.index !== 'undefined' ? !robots.index : typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : false,
  nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : false,
  description: description || METADATA?.description,
  openGraph: openGraphFormatted,
  twitter: twitter?.handle || twitter?.site || twitter?.cardType || METADATA?.twitter
    ? {
        card: (twitter.cardType as any) || (adaptedOpenGraph?.images?.length ? 'summary_large_image' : 'summary'),
        site: twitter.site || METADATA?.twitter?.site,
        creator: twitter.handle || METADATA?.twitter?.handle,
      }
    : undefined,
};
---

<SEO {...seoProps} />
